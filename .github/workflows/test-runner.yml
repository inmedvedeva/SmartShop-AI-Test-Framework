name: SmartShop AI Test Runner

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests every day at 2:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - ui
        - api
        - performance
        - visual

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.12]
        browser: [chrome, firefox]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: smartshop_test
          POSTGRES_USER: test_user
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Playwright browsers
      run: |
        playwright install
        playwright install-deps

    - name: Set up environment variables
      run: |
        echo "BASE_URL=https://demo.smartshop.com" >> $GITHUB_ENV
        echo "API_BASE_URL=https://api.smartshop.com" >> $GITHUB_ENV
        echo "HEADLESS=true" >> $GITHUB_ENV
        echo "BROWSER=${{ matrix.browser }}" >> $GITHUB_ENV
        echo "DB_HOST=localhost" >> $GITHUB_ENV
        echo "DB_PORT=5432" >> $GITHUB_ENV
        echo "DB_NAME=smartshop_test" >> $GITHUB_ENV
        echo "DB_USER=test_user" >> $GITHUB_ENV
        echo "DB_PASSWORD=test_password" >> $GITHUB_ENV

    - name: Create reports directory
      run: mkdir -p reports/allure-results reports/html reports/screenshots

    - name: Run UI tests
      if: github.event.inputs.test_type == 'ui' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
      run: |
        pytest tests/ui/ \
          --browser=${{ matrix.browser }} \
          --alluredir=./reports/allure-results \
          --html=./reports/html/ui_test_report.html \
          --self-contained-html \
          -v \
          --tb=short
      env:
        BROWSER: ${{ matrix.browser }}

    - name: Run API tests
      if: github.event.inputs.test_type == 'api' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
      run: |
        pytest tests/api/ \
          --alluredir=./reports/allure-results \
          --html=./reports/html/api_test_report.html \
          --self-contained-html \
          -v \
          --tb=short

    - name: Run performance tests
      if: github.event.inputs.test_type == 'performance' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
      run: |
        pytest tests/performance/ \
          --alluredir=./reports/allure-results \
          --html=./reports/html/performance_test_report.html \
          --self-contained-html \
          -v \
          --tb=short

    - name: Run visual tests
      if: github.event.inputs.test_type == 'visual' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
      run: |
        pytest tests/ui/ -m visual \
          --browser=${{ matrix.browser }} \
          --alluredir=./reports/allure-results \
          --html=./reports/html/visual_test_report.html \
          --self-contained-html \
          -v \
          --tb=short
      env:
        BROWSER: ${{ matrix.browser }}

    - name: Generate Allure report
      if: always()
      run: |
        allure generate ./reports/allure-results --clean -o ./reports/allure-report

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-results-${{ matrix.browser }}-${{ github.run_number }}
        path: |
          reports/
          screenshots/
        retention-days: 30

    - name: Upload Allure report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: allure-report-${{ matrix.browser }}-${{ github.run_number }}
        path: reports/allure-report/
        retention-days: 30

    - name: Deploy Allure Report to GitHub Pages
      if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./reports/allure-report
        destination_dir: allure-reports
        force_orphan: true

    - name: Comment PR with Test Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          let comment = '## 🧪 Test Results\n\n';

          // Add test summary
          if (fs.existsSync('reports/allure-results/executor.json')) {
            const executor = JSON.parse(fs.readFileSync('reports/allure-results/executor.json', 'utf8'));
            comment += `**Test Execution:** ${executor.name}\n`;
            comment += `**Build:** ${executor.buildName}\n\n`;
          }

          // Add test statistics
          if (fs.existsSync('reports/allure-results/widgets/summary.json')) {
            const summary = JSON.parse(fs.readFileSync('reports/allure-results/widgets/summary.json', 'utf8'));
            comment += `**Results:**\n`;
            comment += `- ✅ Passed: ${summary.statistic.passed}\n`;
            comment += `- ❌ Failed: ${summary.statistic.failed}\n`;
            comment += `- ⚠️ Broken: ${summary.statistic.broken}\n`;
            comment += `- 🔄 Skipped: ${summary.statistic.skipped}\n\n`;
          }

          comment += `📊 [View Full Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-reports/)\n`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Test results summary
      if: always()
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Browser:** ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY
        echo "**Python Version:** ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Reports Generated:" >> $GITHUB_STEP_SUMMARY
        echo "- Allure Report: Available as artifact" >> $GITHUB_STEP_SUMMARY
        echo "- HTML Reports: Available as artifact" >> $GITHUB_STEP_SUMMARY
        echo "- Screenshots: Available as artifact" >> $GITHUB_STEP_SUMMARY

  notify:
    needs: test
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Download test results
      uses: actions/download-artifact@v3
      with:
        pattern: test-results-*
        merge-multiple: true

    - name: Parse test results
      id: parse_results
      run: |
        # Count test results
        if [ -f "reports/allure-results/executor.json" ]; then
          echo "Test execution completed"
          echo "status=completed" >> $GITHUB_OUTPUT
        else
          echo "status=failed" >> $GITHUB_OUTPUT
        fi

    - name: Send Slack notification
      if: github.event_name != 'schedule'
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ steps.parse_results.outputs.status }}
        channel: '#qa-notifications'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        text: |
          🧪 SmartShop AI Test Results
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Status:** ${{ steps.parse_results.outputs.status }}
          **Browser:** ${{ matrix.browser }}
          **Workflow:** ${{ github.workflow }}
          **Run:** ${{ github.run_number }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  security-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run security scan
      run: |
        echo "Running security scan..."
        # Security tools can be added here
        # For example: bandit, safety, etc.
        pip install bandit safety
        bandit -r . -f json -o reports/security-scan.json || true
        safety check --json --output reports/safety-scan.json || true

    - name: Upload security scan results
      uses: actions/upload-artifact@v3
      with:
        name: security-scan-results
        path: reports/security-scan.json reports/safety-scan.json
        retention-days: 90

  code-quality:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.12

    - name: Install dependencies
      run: |
        pip install flake8 black isort mypy
        pip install -r requirements.txt

    - name: Run code formatting check
      run: |
        black --check --diff .
        isort --check-only --diff .

    - name: Run linting
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run type checking
      run: |
        mypy . --ignore-missing-imports --no-strict-optional

  dependency-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.12

    - name: Check for outdated dependencies
      run: |
        pip install pipdeptree
        pipdeptree --warn silence
        echo "Dependency tree generated"

    - name: Check for security vulnerabilities
      run: |
        pip install safety
        safety check --full-report
